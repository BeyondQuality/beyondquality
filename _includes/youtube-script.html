<!-- YouTube Episode Description Script -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const episodeDescriptionElement = document.getElementById('episode-description');
    if (!episodeDescriptionElement) return;

    const playListID = 'PLNtskxLbZna6VDjH6hBhYm0mSZKPhX7Fi';

    // YouTube playlist RSS feed URL
    const YOUTUBE_RSS_URL = 'https://www.youtube.com/feeds/videos.xml?playlist_id=' + playListID;

    // Function to truncate text at "Links" word
    function truncateText(text) {
        // Look for "Links" (case insensitive) and truncate just before it
        const linksIndex = text.toLowerCase().indexOf('links');
        if (linksIndex > 0) {
            return text.substring(0, linksIndex).trim();
        }
        
        // Fallback: if no "Links" found, use a reasonable character limit
        const maxLength = 200;
        if (text.length <= maxLength) return text;
        return text.substring(0, maxLength) + '...';
    }

    // Function to update episode description
    function updateEpisodeDescription(video) {
        if (episodeDescriptionElement) {
            episodeDescriptionElement.textContent = truncateText(video.description);
        }
    }

    // Function to show error
    function showError(message) {
        if (episodeDescriptionElement) {
            let playlistURL = 'https://www.youtube.com/playlist?list=' + playListID;
            episodeDescriptionElement.innerHTML = `Unable to load latest episode description. <a href="${playlistURL}" target="_blank" rel="noopener noreferrer">View playlist on YouTube</a>`;
        }
    }

    // Function to show loading
    function showLoading() {
        if (episodeDescriptionElement) {
            episodeDescriptionElement.textContent = 'Loading latest episode description...';
        }
    }

    // Fetch latest video from YouTube RSS feed
    async function fetchLatestVideo() {
        showLoading();

        try {
            // Use a CORS proxy to fetch the RSS feed
            const proxyUrl = 'https://api.allorigins.win/raw?url=';
            const response = await fetch(proxyUrl + encodeURIComponent(YOUTUBE_RSS_URL));

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const xmlText = await response.text();
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlText, 'text/xml');

            // Get the first entry (latest video)
            const entry = xmlDoc.querySelector('entry');
            if (!entry) {
                throw new Error('No video entries found in RSS feed');
            }

            // Extract video data
            const video = {
                title: entry.querySelector('title')?.textContent || 'Untitled',
                link: entry.querySelector('link')?.getAttribute('href') || '',
                description: entry.querySelector('media\\:description, description')?.textContent || '',
                published: entry.querySelector('published')?.textContent || ''
            };

            updateEpisodeDescription(video);

        } catch (error) {
            console.error('Error fetching YouTube video:', error);
            showError(error.message);
        }
    }

    // Start fetching the latest video
    fetchLatestVideo();
});
</script>
