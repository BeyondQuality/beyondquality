<!-- YouTube Latest Video Script -->
<script>
// Cache bust: v1.0
document.addEventListener('DOMContentLoaded', function() {
    const podcastContainer = document.querySelector('.podcast-card');
    if (!podcastContainer) return;

    const playListID = 'PLNtskxLbZna6VDjH6hBhYm0mSZKPhX7Fi';

    // YouTube playlist RSS feed URL
    const YOUTUBE_RSS_URL = 'https://www.youtube.com/feeds/videos.xml?playlist_id=' + playListID;

    // Function to extract video ID from YouTube URL
    function extractVideoId(url) {
        const match = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\n?#]+)/);
        return match ? match[1] : null;
    }


    // Function to truncate text
    function truncateText(text, maxLength = 300) {
        if (text.length <= maxLength) return text;
        return text.substring(0, maxLength) + '...';
    }

    // Function to update podcast section
    function updatePodcastSection(video) {
        const videoId = extractVideoId(video.link);
        if (!videoId) return;

        const videoLink = `https://www.youtube.com/watch?v=${videoId}&list=${playListID}`;
        
        // Update thumbnail
        const thumbnailImg = podcastContainer.querySelector('.podcast-thumbnail');
        const thumbnailLink = podcastContainer.querySelector('.podcast-thumbnail-link');
        
        if (thumbnailImg) {
            thumbnailImg.src = `https://img.youtube.com/vi/${videoId}/mqdefault.jpg`;
            thumbnailImg.alt = video.title;
        }
        
        if (thumbnailLink) {
            thumbnailLink.href = videoLink;
        }

        // Update YouTube link in listening options
        const youtubeLink = podcastContainer.querySelector('.youtube-link');
        if (youtubeLink) {
            youtubeLink.href = videoLink;
        }

        // Update title
        const titleElement = podcastContainer.querySelector('.podcast-title');
        if (titleElement) {
            titleElement.textContent = video.title;
        }

        // Update description
        const descriptionElement = podcastContainer.querySelector('.podcast-description');
        if (descriptionElement) {
            descriptionElement.textContent = `${truncateText(video.description)}`;
        }
    }

    // Function to show error
    function showError(message) {
        const titleElement = podcastContainer.querySelector('.podcast-title');
        const descriptionElement = podcastContainer.querySelector('.podcast-description');
        
        if (titleElement) {
            titleElement.textContent = 'Latest Podcast Episode';
        }
        
        if (descriptionElement) {
            let playlistURL = 'https://www.youtube.com/playlist?list=' + playListID;
            descriptionElement.innerHTML = `Unable to load latest episode. <a href="${playlistURL}" target="_blank" rel="noopener noreferrer">View playlist on YouTube</a>`;
        }
    }

    // Function to show loading
    function showLoading() {
        const titleElement = podcastContainer.querySelector('.podcast-title');
        const descriptionElement = podcastContainer.querySelector('.podcast-description');
        
        if (titleElement) {
            titleElement.textContent = 'Loading latest episode...';
        }
        
        if (descriptionElement) {
            descriptionElement.textContent = 'Fetching the most recent podcast episode...';
        }
    }

    // Fetch latest video from YouTube RSS feed
    async function fetchLatestVideo() {
        showLoading();

        try {
            // Use a CORS proxy to fetch the RSS feed
            const proxyUrl = 'https://api.allorigins.win/raw?url=';
            const response = await fetch(proxyUrl + encodeURIComponent(YOUTUBE_RSS_URL));

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const xmlText = await response.text();
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlText, 'text/xml');

            // Get the first entry (latest video)
            const entry = xmlDoc.querySelector('entry');
            if (!entry) {
                throw new Error('No video entries found in RSS feed');
            }

            // Extract video data
            const video = {
                title: entry.querySelector('title')?.textContent || 'Untitled',
                link: entry.querySelector('link')?.getAttribute('href') || '',
                description: entry.querySelector('media\\:description, description')?.textContent || '',
                published: entry.querySelector('published')?.textContent || ''
            };

            updatePodcastSection(video);

        } catch (error) {
            console.error('Error fetching YouTube video:', error);
            showError(error.message);
        }
    }

    // Start fetching the latest video
    fetchLatestVideo();
});
</script>
